<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Proyecto Iker-I&ntilde;aki 2017</title>

    <!-- Bootstrap Core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/stylish-portfolio.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

  </head>

  <body id="page-top">
    <!-- Desplegable de reglas para el termostato -->
    <a class="menu-toggle rounded" href="#">
      <i class="fa fa-bars"></i>
    </a>
    <nav id="sidebar-wrapper">
      <ul class="sidebar-nav">
        <li class="sidebar-brand">
          <a class="js-scroll-trigger blanco" href=""></a>
        </li>
        <li class="sidebar-nav-item">
          <div class="slidecontainer espacioInferior">
            <input type="checkbox" id="activarReglas" class="js-switch derecha posicionValor" onclick="enviarTermostatoFalse()"><p class="derecha activarReglas blanco">Activar reglas</p>
          </div>
        </li>
        <li class="sidebar-nav-item">
          <div class="slidecontainer">
            <p class="blanco">Termostato</p>
            <input type="range" min="0" max="50" value="20" class="slider-color" id="slider" onchange="enviarTermostatoTrue()">
            <p id="valorTermostato" class="blanco">20 ºC</p>
          </div>
        </li>
        <li class="sidebar-nav-item">
          <div class="slidecontainer">
            <div>
              <i class="icon-phone blanco rigth_5"></i><p class="blanco enLinea" id="conexionIker">Iker:</p>
            </div>
            <div>
              <i class="icon-phone blanco rigth_5"></i><p class="blanco enLinea" id="conexionInaki">I&ntilde;aki:</p>
            </div>
          </div>
        </li>
        <li class="sidebar-nav-item">
          <div class="slidecontainer espacioInferior">
            <input type="checkbox" id="enCasa" class="js-switch derecha posicionValor" onclick="enviarDataosPresencia()"><p class="derecha activarReglas blanco">En casa</p>
          </div>
        </li>
      </ul>
    </nav>

    <!-- Titulo -->
    <section class="content-section colorFondoBlanco text-white text-center" id="services">
      <h1 class="colorLetrasAzul">Proyecto Iker-I&ntilde;aki 2017</h1>
    </section>

    <!-- Grafica a tiempo real -->
    <section class="content-section bg-primary text-white text-center" id="services">
      <div class="container width_90">
        <div class="content-section-heading">
          <h2 class="mb-5">Datos a tiempo real</h2>
        </div>
        <div class="row">
          <div class="col-lg-2 col-md-4 mb-2 mb-lg-0">
            <div class="row">
              <span class="service-icon rounded-circle mx-auto mb-3">
                <i class="icon-fire"></i>
              </span>
              <h4 class="width_maximo">
                <strong id="temperatura"></strong><strong> ºC</strong>
              </h4>
              <p class="text-faded mb-0 texto-datos width_maximo">Temperatura</p>
            </div>
            <div class="row margin_top_20">
              <span class="service-icon rounded-circle mx-auto mb-3">
                <i class="icon-drop"></i>
              </span>
              <h4 class="width_maximo">
                <strong id="humedad"></strong><strong> %</strong>
              </h4>
              <p class="text-faded mb-0 texto-datos width_maximo">Humedad</p>
            </div>
            <div class="row margin_top_20">
              <span class="service-icon rounded-circle mx-auto mb-3">
                <i class="icon-bulb"></i>
              </span>
              <h4 class="width_maximo">
                <strong id="luz"></strong><strong> %</strong>
              </h4>
              <p class="text-faded mb-0 texto-datos width_maximo">Luz</p>
            </div>
          </div>
          <div class="col-lg-10 col-md-8 mb-10 mb-lg-0 align-middle">
            <div id="chartContainer" style="height: 100%; width:100%;"></div>
          </div>
          
        </div>
      </div>
    </section>

    <!-- Graficas de los datos globales de temperatura, humedad y luz -->
    <section class="content-section bg-segundo text-white text-center">
      <div class="container width_90">
        <div class="row">
          <div class="col-lg-4 col-md-6 mb-4 mb-lg-0">
            <img src="images/temperatura.jpg" style="height: 400px">
          </div>
          <div class="col-lg-8 col-md-6 mb-8 mb-lg-0 align-middle">
            <div id="chart_temperatura"></div>
          </div>
        </div>
        <div class="row desplegable">
          <div class="col-md-12">
            <select id="diasTemperatura" onchange="cargarTablaTemperatura()">
               <option value="0">Todos los datos</option>
               <option value="1">Ultimas 24h</option> 
               <option value="2">Ultima semana</option> 
               <option value="3">Ultimo mes</option>
            </select>
          </div>
      </div>
    </section>
    <section class="content-section bg-tercero text-white text-center">
      <div class="container width_90">
        <div class="row">
          <div class="col-lg-4 col-md-6 mb-4 mb-lg-0">
            <img src="images/humedad.jpg" style="height: 400px">
          </div>
          <div class="col-lg-8 col-md-6 mb-8 mb-lg-0 align-middle">
            <div id="chart_humedad"></div>
          </div>
        </div>
        <div class="row desplegable">
          <div class="col-md-12">
            <select id="diasHumedad" onchange="cargarTablaHumedad()">
               <option value="0">Todos los datos</option>
               <option value="1">Ultimas 24h</option> 
               <option value="2">Ultima semana</option> 
               <option value="3">Ultimo mes</option>
            </select>
          </div>
        </div>
      </div>
    </section>
    <section class="content-section bg-cuarto text-white text-center">
      <div class="container width_90">
        <div class="row">
          <div class="col-lg-4 col-md-6 mb-4 mb-lg-0">
            <img src="images/luz.jpg" style="height: 400px">
          </div>
          <div class="col-lg-8 col-md-6 mb-8 mb-lg-0 align-middle">
            <div id="chart_luz"></div>
          </div>
        </div>
        <div class="row desplegable">
          <div class="col-md-12">
            <select id="diasLuz" onchange="cargarTablaLuz()">
               <option value="0">Todos los datos</option>
               <option value="1">Ultimas 24h</option> 
               <option value="2">Ultima semana</option> 
               <option value="3">Ultimo mes</option>
            </select>
          </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer text-center">
      <div class="container">
        <ul class="list-inline mb-5">
          <li class="list-inline-item">
            <a class="social-link rounded-circle text-white" target="_blank" href="https://github.com/inakidml/proyecto-2017">
              <i class="icon-social-github"></i>
            </a>
          </li>
        </ul>
        <p class="text-muted small mb-0">Copyright &copy; Your Website 2017</p>
      </div>
    </footer>

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded js-scroll-trigger" href="#page-top">
      <i class="fa fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="js/stylish-portfolio.min.js"></script>
    <script>

      //Funcion para recoger los datos de la tabla temperatura y dependiendo de los dias seleccionados mostrar mas o menos
      function cargarTablaTemperatura(){
        var x = document.getElementById("diasTemperatura").value;

        var queryTem = "";

        switch(x){
          case "0":
            queryTem = "SELECT * FROM `registro`";
            break;
          case "1":
            queryTem = "SELECT * FROM `registro` where fecha between date_add(curdate(), interval -1 day) and date_add(curdate(), interval +1 day)";
            break;
          case "2":
            queryTem = "SELECT * FROM `registro` where fecha between date_add(curdate(), interval -1 week) and date_add(curdate(), interval +1 week)";
            break;
          case "3":
            queryTem = "SELECT * FROM `registro` where fecha between date_add(curdate(), interval -1 month) and date_add(curdate(), interval +1 month)";
            break;
        }

        var dataLength = 0;
        var data = [];
        $.getJSON("getTemperatura.php", {sql:queryTem}, function (result) {
          dataLength = result.length;
            for (var i = 0; i < dataLength; i++) {
              data.push({
                label: (result[i].fecha),
                y: parseFloat(result[i].temperatura)
              });
            }
            ;
            chart2.render();       
          });

          var chart2 = new CanvasJS.Chart("chart_temperatura", {
            zoomEnabled: true, 
            title: {
              text: "Temperatura"
            },
            axisX: {
              title: "Fecha",
              labelAngle: 45
            },
            data: [{type: "line", dataPoints: data, color: "red"}],
            });
      }

      //Funcion para recoger los datos de la tabla humedad y dependiendo de los dias seleccionados mostrar mas o menos
      function cargarTablaHumedad(){
        var x = document.getElementById("diasHumedad").value;

        var queryHum = "";

        switch(x){
          case "0":
            queryHum = "SELECT * FROM `registro`";
            break;
          case "1":
            queryHum = "SELECT * FROM `registro` where fecha between date_add(curdate(), interval -1 day) and date_add(curdate(), interval +1 day)";
            break;
          case "2":
            queryHum = "SELECT * FROM `registro` where fecha between date_add(curdate(), interval -1 week) and date_add(curdate(), interval +1 week)";
            break;
          case "3":
            queryHum = "SELECT * FROM `registro` where fecha between date_add(curdate(), interval -1 month) and date_add(curdate(), interval +1 month)";
            break;
        }

        var dataLength2 = 0;
        var data2 = [];
        $.getJSON("getHumedad.php", {sql:queryHum}, function (result) {
          dataLength2 = result.length;
            for (var i = 0; i < dataLength2; i++) {
              data2.push({
                label: (result[i].fecha),
                y: parseFloat(result[i].humedad)
              });
            }
          ;
          chart3.render();         
        });

        var chart3 = new CanvasJS.Chart("chart_humedad", {
          zoomEnabled: true, 
          title: {
            text: "Humedad"
          },
          axisX: {
            title: "Fecha",
            labelAngle: 45
          },
          data: [{type: "column", dataPoints: data2, color: "rgba(0, 201, 255, 0.4)"}],
        });
      }

      //Funcion para recoger los datos de la tabla luz y dependiendo de los dias seleccionados mostrar mas o menos
      function cargarTablaLuz(){
        var x = document.getElementById("diasLuz").value;

        var queryLuz = "";

        switch(x){
          case "0":
            queryLuz = "SELECT * FROM `registro`";
            break;
          case "1":
            queryLuz = "SELECT * FROM `registro` where fecha between date_add(curdate(), interval -1 day) and date_add(curdate(), interval +1 day)";
            break;
          case "2":
            queryLuz = "SELECT * FROM `registro` where fecha between date_add(curdate(), interval -1 week) and date_add(curdate(), interval +1 week)";
            break;
          case "3":
            queryLuz = "SELECT * FROM `registro` where fecha between date_add(curdate(), interval -1 month) and date_add(curdate(), interval +1 month)";
            break;
        }

        var dataLength3 = 0;
        var data3 = [];
        $.getJSON("getLuz.php", {sql:queryLuz}, function (result) {
          dataLength3 = result.length;
            for (var i = 0; i < dataLength3; i++) {
              data3.push({
                label: (result[i].fecha),
                y: parseFloat(result[i].luz)
              });
            }
          ;
          chart4.render();         
        });

        var chart4 = new CanvasJS.Chart("chart_luz", {
          zoomEnabled: true, 
          title: {
            text: "Luz"
          },
          axisX: {
            title: "Fecha",
            labelAngle: 45
          },
          data: [{type: "area", dataPoints: data3, color: "rgba(255, 255, 0, 0.2)"}],
        });
      }

      //Funcion que controla el estado de los telefonos conectados a la red
      function controladorTermostato(){
        $.getJSON("getPhoneIker.php", function (result) {
          $("#conexionIker").text("Iker: " + result);
        });

        $.getJSON("getPhoneInaki.php", function (result) {
          $("#conexionInaki").text("Iñaki: " + result);
        });
      }

      //Funcion para enviar al socket los datos actuales de las reglas cuando estan activadas
      function enviarTermostatoTrue(){
        var x = document.getElementById("slider").value;
        var casa = false;

        if($("#enCasa").is(':checked')){
          casa = true;
        }

        $("#valorTermostato").text(x + " ºC");

        var datos = x + "," + true + "," + casa;

        jQuery.ajax({
                            type: "GET",
                            url: "http://192.168.33.10:4455",
                            dataType: "json",
                            data: datos,
                            success: function (response) {
                            },
                            error: function (xhr, ajaxOptions, thrownError) {
                            }
                          });
      }

      //Funcion para enviar al socket los datos actuales de las reglas cuando estan desactivadas
      function enviarTermostatoFalse(){
        if(!$("#activarReglas").is(':checked')){
          var x = document.getElementById("slider").value;
          var datos = "";

          var casa = false;

          if($("#enCasa").is(':checked')){
            casa = true;
          }

          datos = x + "," + false + "," + casa;

          jQuery.ajax({
                              type: "GET",
                              url: "http://192.168.33.10:4455",
                              dataType: "json",
                              data: datos,
                              success: function (response) {
                              },
                              error: function (xhr, ajaxOptions, thrownError) {
                              }
                            });
        }else{
          var x = document.getElementById("slider").value;
          var datos = "";

          var casa = false;

          if($("#enCasa").is(':checked')){
            casa = true;
          }

          datos = x + "," + true + "," + casa;

          jQuery.ajax({
                              type: "GET",
                              url: "http://192.168.33.10:4455",
                              dataType: "json",
                              data: datos,
                              success: function (response) {
                              },
                              error: function (xhr, ajaxOptions, thrownError) {
                              }
                            });
        }
      }

      //Funcion para enviar al socket los datos de los telefonos(si estan conectados o no)
      function enviarDataosPresencia(){
        if($("#activarReglas").is(':checked')){
          enviarTermostatoTrue();
        }else{
          enviarTermostatoFalse();
        }
      }

      //Funcion para cargar los datos guardados por el socket en la base de datos y que asi se mantengan cuando se cerro la web
      function cargarDatosGuardados(){
        $.getJSON("getDatosInicio.php", function (result) {
          for (var i = 0; i < result.length; i++) {
            $("#valorTermostato").text(result[i].temperatura + " ºC");
            $("#slider").val(parseInt(result[i].temperatura));

            if(parseInt(result[i].controlAct) == 1){
              $("#activarReglas").prop('checked', true);
            }

            if(parseInt(result[i].reglasPres) == 1){
              $("#enCasa").prop('checked', true);
            }

          }
        });
      }

      //Funcion para ejecutar todo al abrir la web
      window.onload = function () {
        //Cargamos todos los datos
        cargarDatosGuardados();
        cargarTablaTemperatura();
        cargarTablaHumedad();
        cargarTablaLuz();

        //Cargamos los datos para la grafica de datos en tiempo real
            var dps = [];
            var dps2 = [];
            var dps3 = [];
            var chart = new CanvasJS.Chart("chartContainer", {
                axisY: {
                    includeZero: false
                },
                axisX: {
                    labelAngle: 45
                },
                data: [{
                    type: "column",
                    dataPoints: dps2,
                    color: "rgba(0, 201, 255, 0.4)"
                },
                {
                    type: "area",
                    dataPoints: dps3,
                    color: "rgba(255, 255, 0, 0.2)"
                },
                {
                    type: "line",
                    dataPoints: dps,
                    color: "red"
                }]
            });

            var xVal = 0;
            var yVal = 100; 
            var updateInterval = 1050;
            var dataLength = 20;

            //Actualizamos los datos de la grafica a tiempo real
            var updateChart = function (count) {

                count = count || 1;

                for (var j = 0; j < count; j++) {
                    $.getJSON("getDatosReal.php", function (result) {
                    dataLength = result.length;
                    for (var i = 0; i < dataLength; i++) {
                        dps.push({
                            x: new Date(result[i].fecha),
                            y: parseFloat(result[i].temperatura)
                        });
                        dps2.push({
                            x: new Date(result[i].fecha),
                            y: parseFloat(result[i].humedad)
                        });
                        dps3.push({
                            x: new Date(result[i].fecha),
                            y: parseFloat(result[i].luz)
                        });

                        $("#temperatura").text(result[i].temperatura);
                        $("#humedad").text(result[i].humedad);
                        $("#luz").text(result[i].luz);

                        controladorTermostato();

                        if($('#activarReglas').is(":checked")){
                          $("#slider").prop('disabled', false);
                        }else{
                          $("#slider").prop('disabled', true);
                        }
                        
                    }
                    ;
                    chart.render();
                    
                });
                }

                if (dps.length > dataLength) {
                    dps.shift();
                    dps2.shift();
                    dps3.shift();
                }

                chart.render();
            };

            updateChart(dataLength);
            setInterval(function(){updateChart()}, updateInterval);

          }
    </script>

    <script type="text/javascript" src="assets/script/canvasjs.min.js"></script>
    <script type="text/javascript" src="assets/script/jquery-2.2.3.min.js"></script>

  </body>

</html>
